<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geidea System Diagnostics (KSA Edition)</title>
    
    <!-- 
       FIX: ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ∞Ÿä Ÿàÿ¨ÿØÿ™Ÿá
       1. ŸÜÿ≠ÿßŸàŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä (geideaCheckout.min.js)
       2. ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∞Ÿä Ÿàÿ¨ÿØÿ™Ÿá ÿ£ŸÜÿ™ ŸÉÿ®ÿØŸäŸÑ
    -->
    <script src="geideaCheckout.min.js" onerror="loadExternalScript()"></script>
    
    <script>
        function loadExternalScript() {
            console.warn("Local script not found, trying CDN...");
            var script = document.createElement('script');
            // ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÑŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∞Ÿä ŸäÿπŸÖŸÑ ŸÖÿπŸÉ
            script.src = "https://www.ksamerchant.geidea.net/hpp/geideaCheckout.min.js";
            script.onload = function() { window.geideaScriptLoaded = true; };
            script.onerror = function() { window.geideaScriptFailed = true; };
            document.head.appendChild(script);
        }
        // ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ ŸÑŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä
        window.onload = function() {
            if (typeof GeideaCheckout !== 'undefined') window.geideaScriptLoaded = true;
        }
    </script>
    
    <style>
        :root { --bg: #1e1e1e; --term-bg: #000; --text: #e0e0e0; --green: #00ff00; --red: #ff4444; --yellow: #ffff00; --blue: #4488ff; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', 'Monaco', monospace; margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: var(--green); text-align: center; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        button { background: var(--green); color: black; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 5px; text-transform: uppercase; transition: 0.2s; margin-bottom: 20px; }
        button:hover { background: #00cc00; }
        button:disabled { background: #555; cursor: wait; }
        .terminal-window { background: var(--term-bg); border: 2px solid #333; border-radius: 6px; padding: 15px; height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        .log-time { color: #666; margin-right: 10px; }
        .status-ok { color: var(--green); font-weight: bold; }
        .status-fail { color: var(--red); font-weight: bold; }
        .status-warn { color: var(--yellow); }
        .details { margin-left: 70px; color: #888; font-size: 12px; white-space: pre-wrap; display: block; margin-top: 2px; }
        #copyBtn { position: absolute; top: 10px; right: 10px; background: #333; color: white; padding: 5px 10px; font-size: 12px; width: auto; border: 1px solid #555; cursor: pointer; }
        
        /* ÿ™ŸÜÿ®ŸäŸá ŸÑŸÑÿÆÿ∑ÿ£ */
        .alert-box { background: #ff444433; border: 1px solid #ff4444; color: #ffaaaa; padding: 10px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Geidea Diagnostics (KSA üá∏üá¶ Final)</h1>
        
        <div id="libAlert" class="alert-box">
            ‚ö†Ô∏è <b>Warning:</b> Geidea Library failed to load! <br>
            1. Ensure <code>geideaCheckout.min.js</code> is in the same folder.<br>
            2. Disable AdBlock or check internet connection.
        </div>

        <button id="startBtn" onclick="runFullDiagnostics()">‚ö° START SAUDI TESTS</button>
        
        <div class="terminal-window">
            <button id="copyBtn" onclick="copyLogs()">Copy Logs</button>
            <div id="terminalOutput">
                <div class="log-entry">> Ready. Click Start...</div>
            </div>
        </div>
    </div>

    <script>
        const SAUDI_COUNTRY_CODE = "+966";
        const SAUDI_PHONE_NUMBER = "550063691"; 

        const OPERATIONS = [
            { 
                id: 'createSession', 
                name: 'Checkout V2 Session', 
                payload: { 
                    amount: 100, 
                    currency: "SAR", 
                    paymentOperation: "Pay", 
                    appearance: { uiMode: "modal" }, 
                    customer: { 
                        email: "test@geidea-ksa.com",
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                },
                checkWindow: true 
            },
            { 
                id: 'createQuickLink', 
                name: 'Quick Payment Link (SMS)', 
                payload: { 
                    amount: 150, 
                    currency: "SAR", 
                    customer: { 
                        name: "KSA Customer", 
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                } 
            },
            { 
                id: 'saveCard', 
                name: 'Save Card (Tokenization)', 
                payload: { currency: "SAR" }
            },
            { 
                id: 'createSubscription', 
                name: 'Create Subscription', 
                payload: { 
                    recurringPaymentAmount: 50, 
                    currency: "SAR", 
                    cycleInterval: "month", 
                    cycleFrequency: 12, 
                    typeOfPayment: "RecurringPayment", 
                    isFirstPmtPBL: false, 
                    customerRequest: { 
                        email: "sub@geidea-ksa.com",
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                } 
            }
        ];

        let logsText = "";
        let lastSessionId = null;

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÅŸàÿ±Ÿä ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('load', () => {
            // --- ÿ¨ÿØŸäÿØ: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÖÿß ÿ•ÿ∞ÿß ŸÉŸÜÿß ÿπÿßÿ¶ÿØŸäŸÜ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ®ŸÜŸÉ ---
            const urlParams = new URLSearchParams(window.location.search);
            // Geidea ÿπÿßÿØÿ© ÿ™ÿ±ÿ≥ŸÑ responseCode ŸÅŸä ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿπŸÜÿØ ÿßŸÑÿπŸàÿØÿ©
            if (urlParams.has('responseCode')) {
                const code = urlParams.get('responseCode');
                const msg = urlParams.get('responseMessage') || "Process Completed";
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ±ÿßÿ®ÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
                window.history.replaceState({}, document.title, window.location.pathname);

                // ÿßŸÑŸÉŸàÿØ 000 ŸäÿπŸÜŸä ŸÜÿ¨ÿßÿ≠
                if (code === '000' || code === '0') {
                    setTimeout(() => {
                        log("‚úÖ üí∞ PAYMENT SUCCESSFUL (Returned from Bank)", "success", `Code: ${code}\nMsg: ${msg}`);
                        alert("‚úÖ ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!\n(Payment Approved)");
                    }, 500);
                } else {
                    setTimeout(() => {
                        log("‚ùå Payment Failed (Returned from Bank)", "error", `Code: ${code}\nMsg: ${msg}`);
                        alert("‚ùå ŸÑŸÖ ÿ™ŸÉÿ™ŸÖŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©.\n" + msg);
                    }, 500);
                }
            }
            // -----------------------------------------------------

            // ŸÜŸÜÿ™ÿ∏ÿ± ŸÇŸÑŸäŸÑÿßŸã ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ
            setTimeout(() => {
                if (window.geideaScriptFailed && typeof GeideaCheckout === 'undefined') {
                    document.getElementById('libAlert').style.display = 'block';
                }
            }, 1000);
        });

        function log(message, type = 'info', details = null) {
            const term = document.getElementById('terminalOutput');
            const time = new Date().toLocaleTimeString();
            let colorClass = '';
            
            if (type === 'success') colorClass = 'status-ok';
            else if (type === 'error') colorClass = 'status-fail';
            else if (type === 'warn') colorClass = 'status-warn';

            let html = `<div class="log-entry">
                <span class="log-time">[${time}]</span>
                <span class="${colorClass}">${message}</span>`;
            
            if (details) {
                html += `<span class="details">${details}</span>`;
            }
            html += `</div>`;

            term.innerHTML += html;
            term.scrollTop = term.scrollHeight;
            logsText += `[${time}] ${message}\n${details ? details + '\n' : ''}`;
        }

        async function runFullDiagnostics() {
            const btn = document.getElementById('startBtn');
            const term = document.getElementById('terminalOutput');
            
            btn.disabled = true;
            term.innerHTML = "";
            logsText = "";
            
            log("üöÄ Starting KSA Diagnostic Sequence (Updated)...", "warn");
            log(`‚ÑπÔ∏è Phone: ${SAUDI_COUNTRY_CODE}-${SAUDI_PHONE_NUMBER}`, "info");
            log("---------------------------------------------------");

            // ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÉÿ´ÿ± ÿØŸÇÿ©
            if (typeof GeideaCheckout === 'undefined') {
                log("‚ùå CRITICAL: Geidea JS Library NOT loaded.", "error");
                log("   -> Trying to load from local file or CDN failed.", "warn");
            } else {
                log("‚úÖ Geidea JS Library Loaded successfully.", "success");
            }

            for (let op of OPERATIONS) {
                await runSingleTest(op);
                await new Promise(r => setTimeout(r, 1000));
            }

            log("---------------------------------------------------");
            log("üèÅ Diagnostic Complete.", "warn");
            btn.disabled = false;
        }

        async function runSingleTest(op) {
            log(`üîÑ Testing: ${op.name} [${op.id}]...`, "info");

            let currentPayload = { ...op.payload };

            try {
                const res = await fetch('/.netlify/functions/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: op.id, payload: currentPayload })
                });

                const data = await res.json();
                const status = data._statusCode || res.status;

                if (status >= 200 && status < 300) {
                    let detailMsg = `Status: ${status} OK`;
                    const sessId = data.session?.id || data.id;
                    
                    if (sessId && op.id === 'createSession') {
                        lastSessionId = sessId;
                        detailMsg += `\nüÜî Session ID: ${sessId}`;
                        
                        if (op.checkWindow) {
                            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÇÿ®ŸÑ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≤ÿ±
                            if (typeof GeideaCheckout !== 'undefined') {
                                detailMsg += `\n‚úÖ Window Ready`;
                                setTimeout(() => {
                                    const btnId = `btn-${sessId.substring(0,8)}`;
                                    const term = document.getElementById('terminalOutput');
                                    term.lastElementChild.innerHTML += ` <button id="${btnId}" style="width:auto; padding:2px 10px; font-size:10px; margin:0; display:inline;" onclick="openTestWindow('${sessId}')">Test Window</button>`;
                                }, 100);
                            } else {
                                detailMsg += `\n‚ö†Ô∏è Session Created, but JS Lib missing (Cannot open window)`;
                            }
                        }
                    }
                    
                    if (data.paymentUrl) {
                        detailMsg += `\nüîó URL: ${data.paymentUrl}`;
                    }

                    log(`‚úÖ ${op.name}: SUCCESS`, "success", detailMsg);

                } else {
                    let errorMsg = JSON.stringify(data);
                    if (data.detailedResponseMessage) errorMsg = data.detailedResponseMessage;
                    else if (data.responseMessage) errorMsg = data.responseMessage;
                    else if (data.errors) errorMsg = JSON.stringify(data.errors);
                    
                    log(`‚ùå ${op.name}: FAILED (${status})`, "error", `Server Msg: ${errorMsg}\nPayload: ${JSON.stringify(currentPayload)}`);
                }

            } catch (err) {
                log(`‚ùå ${op.name}: NETWORK ERROR`, "error", err.message);
            }
        }

        function openTestWindow(sessionId) {
            if (typeof GeideaCheckout === 'undefined') {
                alert("Cannot open payment window: Library not loaded (Check AdBlock)");
                return;
            }
            
            // ŸÇŸÖÿ™ ŸÅŸÇÿ∑ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ŸÜÿ®ŸäŸá (Alert) ŸáŸÜÿß ŸÅŸä ÿ≠ÿßŸÑ ŸÑŸÖ Ÿäÿ≠ÿØÿ´ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸÑÿµŸÅÿ≠ÿ©
            const payment = new GeideaCheckout(
                function(successData) {
                    console.log("Success:", successData);
                    log("‚úÖ üí∞ PAYMENT SUCCESSFUL!", "success", JSON.stringify(successData));
                    // Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ∏Ÿáÿ± ÿ•ÿ∞ÿß ÿ£ÿ∫ŸÑŸÇÿ™ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ÿØŸàŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
                    alert("‚úÖ ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!\nPayment Successful!");
                }, 
                function(errorData) {
                    console.error("Error:", errorData);
                    log("‚ùå Payment Failed", "error", JSON.stringify(errorData));
                    alert("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÅÿπ.");
                }, 
                function() {
                    console.log("Cancel");
                    log("‚ö†Ô∏è Payment Cancelled", "warn");
                }
            );
            
            payment.startPayment(sessionId);
        }

        function copyLogs() {
            navigator.clipboard.writeText(logsText).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerText = "Copied!";
                setTimeout(() => btn.innerText = "Copy Logs", 2000);
            });
        }
    </script>
</body>
</html>