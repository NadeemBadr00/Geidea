<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© - Geidea & Firebase</title>
    
    <!-- Geidea Script -->
    <script src="geideaCheckout.min.js" onerror="loadExternalScript()"></script>
    <script>
        function loadExternalScript() {
            console.warn("Local script not found, trying CDN...");
            var script = document.createElement('script');
            script.src = "https://www.ksamerchant.geidea.net/hpp/geideaCheckout.min.js";
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h2 { color: #333; margin-bottom: 0.5rem; }
        .price-tag { background: #e8f5e9; color: #2e7d32; padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; margin-top: 15px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 15px; font-size: 14px; color: #666; min-height: 20px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: none; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h2>Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h2>
        <div class="price-tag">Ø¨Ø§Ù‚Ø© 100 Ø±.Ø³</div>
        
        <div id="authForm">
            <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button id="payBtn" onclick="handleRegisterAndPay()">
                <span class="loader" id="loader"></span>
                Ø¯ÙØ¹ ÙˆØ´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©
            </button>
        </div>

        <div id="statusMessage" class="status"></div>
    </div>

    <!-- Firebase Configuration & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6WQKgXjdqe3ghQEQ5EXAMZM7ffiWlabk",
            authDomain: "ai-roadmap-jnadeem.firebaseapp.com",
            projectId: "ai-roadmap-jnadeem",
            storageBucket: "ai-roadmap-jnadeem.firebasestorage.app",
            messagingSenderId: "332299268804",
            appId: "1:332299268804:web:225b27d243845688194f91",
            measurementId: "G-P8E119RZDX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');
        const payBtn = document.getElementById('payBtn');
        const statusDiv = document.getElementById('statusMessage');
        const loader = document.getElementById('loader');

        // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡
        const PAYMENT_AMOUNT = 100.00;

        window.handleRegisterAndPay = async () => {
            const name = nameInput.value;
            const email = emailInput.value;
            const password = passInput.value;

            if(!email || !password || !name) {
                showStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "red");
                return;
            }

            setLoading(true);

            try {
                let user;
                let isNewUser = false;

                // 1. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¯Ø®ÙˆÙ„)
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    user = userCredential.user;
                    isNewUser = true;
                    showStatus("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "green");
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        showStatus("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...", "blue");
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        user = userCredential.user;
                    } else {
                        throw authError;
                    }
                }

                // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
                if (isNewUser) {
                    await createUserDocument(user, name);
                }

                // 3. Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
                await initiatePayment(user.uid);

            } catch (error) {
                console.error(error);
                showStatus("Ø®Ø·Ø£: " + error.message, "red");
                setLoading(false);
            }
        };

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        async function createUserDocument(user, displayName) {
            try {
                const userRef = doc(db, "users", user.uid);
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: displayName,
                    email: user.email,
                    walletBalance: 0, // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
                    isPremium: false,
                    photoURL: user.photoURL || "",
                    subscriptionPlan: "free",
                    createdAt: serverTimestamp(),
                    referredBy: "" // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€ URL parameters
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Auth Ø£ÙŠØ¶Ø§Ù‹
                await updateProfile(user, { displayName: displayName });
                
            } catch (e) {
                console.error("Error creating user doc:", e);
                // Ù„Ù† Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‡Ù†Ø§ØŒ Ø³Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯ÙØ¹
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­
        async function updateUserBalance(userId) {
            try {
                const userRef = doc(db, "users", userId);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… increment Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
                await updateDoc(userRef, {
                    walletBalance: increment(PAYMENT_AMOUNT),
                    isPremium: true, // Ù…Ø«Ø§Ù„: ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø­Ù†
                    lastPaymentDate: serverTimestamp()
                });
                
                console.log("Wallet Updated Successfully");
            } catch (e) {
                console.error("Error updating wallet:", e);
                showStatus("ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯. ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§.", "orange");
                throw e;
            }
        }

        async function initiatePayment(userId) {
            showStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹...", "blue");

            try {
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Netlify Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Session ID
                const response = await fetch('/.netlify/functions/create-payment-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: PAYMENT_AMOUNT, 
                        customerEmail: emailInput.value,
                        userId: userId 
                    })
                });

                const data = await response.json();

                if (data.success && data.sessionId) {
                    showStatus("Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ Ø¬Ø§Ù‡Ø²Ø©...", "green");
                    startGeideaPayment(data.sessionId, userId);
                } else {
                    throw new Error(data.error || "ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©");
                }

            } catch (err) {
                console.error(err);
                showStatus("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message, "red");
                setLoading(false);
            }
        }

        function startGeideaPayment(sessionId, userId) {
            if (typeof GeideaCheckout === 'undefined') {
                showStatus("Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª.", "red");
                setLoading(false);
                return;
            }

            const payment = new GeideaCheckout(
                async function(success) {
                    console.log("Payment Success:", success);
                    showStatus("âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹! Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©...", "blue");
                    
                    try {
                        // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙÙŠ Firestore
                        await updateUserBalance(userId);
                        showStatus("ğŸ‰ ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø²Ø§Ø¯ Ø¨Ù…Ù‚Ø¯Ø§Ø± " + PAYMENT_AMOUNT, "green");
                        
                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ
                        setTimeout(() => {
                            setLoading(false);
                            alert("ØªÙ… Ø´Ø­Ù† Ù…Ø­ÙØ¸ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!");
                        }, 1000);
                        
                    } catch (err) {
                        setLoading(false);
                    }
                },
                function(error) {
                    console.error("Payment Error:", error);
                    showStatus("âŒ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "red");
                    setLoading(false);
                },
                function() {
                    showStatus("âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "orange");
                    setLoading(false);
                }
            );

            payment.startPayment(sessionId);
        }

        function showStatus(msg, color) {
            statusDiv.innerText = msg;
            statusDiv.style.color = color || "black";
        }

        function setLoading(isLoading) {
            payBtn.disabled = isLoading;
            loader.style.display = isLoading ? "inline-block" : "none";
        }
    </script>
</body>
</html>