<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geidea System Diagnostics (KSA Edition)</title>
    <script src="https://ksamerchant.geidea.net/payment-intent/online/v1/geidea-checkout.min.js"></script>
    <style>
        :root { --bg: #1e1e1e; --term-bg: #000; --text: #e0e0e0; --green: #00ff00; --red: #ff4444; --yellow: #ffff00; --blue: #4488ff; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', 'Monaco', monospace; margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: var(--green); text-align: center; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        button { background: var(--green); color: black; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 5px; text-transform: uppercase; transition: 0.2s; margin-bottom: 20px; }
        button:hover { background: #00cc00; }
        button:disabled { background: #555; cursor: wait; }
        .terminal-window { background: var(--term-bg); border: 2px solid #333; border-radius: 6px; padding: 15px; height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        .log-time { color: #666; margin-right: 10px; }
        .status-ok { color: var(--green); font-weight: bold; }
        .status-fail { color: var(--red); font-weight: bold; }
        .status-warn { color: var(--yellow); }
        .details { margin-left: 70px; color: #888; font-size: 12px; white-space: pre-wrap; display: block; margin-top: 2px; }
        #copyBtn { position: absolute; top: 10px; right: 10px; background: #333; color: white; padding: 5px 10px; font-size: 12px; width: auto; border: 1px solid #555; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Geidea Diagnostics (KSA ðŸ‡¸ðŸ‡¦ Final)</h1>
        
        <button id="startBtn" onclick="runFullDiagnostics()">âš¡ START SAUDI TESTS</button>
        
        <div class="terminal-window">
            <button id="copyBtn" onclick="copyLogs()">Copy Logs</button>
            <div id="terminalOutput">
                <div class="log-entry">> Ready. Click Start...</div>
            </div>
        </div>
    </div>

    <script>
        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù„ØªÙ„Ø¨ÙŠØ© Ù…ØªØ·Ù„Ø¨Ø§Øª Geidea
        // Ø§Ù„Ø±Ù‚Ù…: +966550063691
        const SAUDI_COUNTRY_CODE = "+966";
        const SAUDI_PHONE_NUMBER = "550063691"; // Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ

        const OPERATIONS = [
            { 
                id: 'createSession', 
                name: 'Checkout V2 Session', 
                payload: { 
                    amount: 100, 
                    currency: "SAR", 
                    paymentOperation: "Pay", 
                    appearance: { uiMode: "modal" }, 
                    customer: { 
                        email: "test@geidea-ksa.com",
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                },
                checkWindow: true 
            },
            { 
                id: 'createQuickLink', 
                name: 'Quick Payment Link (SMS)', 
                payload: { 
                    amount: 150, 
                    currency: "SAR", 
                    customer: { 
                        name: "KSA Customer", 
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                }
            },
            { 
                id: 'createPaymentLink', 
                name: 'Invoice Payment Link', 
                payload: { 
                    amount: 0, 
                    currency: "SAR", 
                    customer: { 
                        name: "KSA Invoice", 
                        email: "invoice@geidea-ksa.com",
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    },
                    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ­ØªÙˆÙŠ Ù…Ù†ØªØ¬ Ù‚ÙŠÙ…ØªÙ‡ 200
                    eInvoiceItems: [
                        {
                            item: "Test Product",
                            description: "Diagnostics Test Item",
                            price: 0,
                            quantity: 1,
                            total: 0,
                            currency: "SAR"
                        }
                    ],
                    eInvoiceDetails: { 
                        // Ø§Ù„Ø¢Ù† ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬ (200)
                        subtotal: 0, 
                        grandTotal: 0, 
                        extraChargesType: "Amount", 
                        invoiceDiscountType: "Amount" 
                    }
                }
            },
            { 
                id: 'saveCard', 
                name: 'Save Card (Tokenization)', 
                payload: { currency: "SAR" }
            },
            { 
                id: 'createSubscription', 
                name: 'Create Subscription', 
                payload: { 
                    recurringPaymentAmount: 50, 
                    currency: "SAR", 
                    cycleInterval: "month", 
                    cycleFrequency: 12, 
                    typeOfPayment: "RecurringPayment", 
                    isFirstPmtPBL: false, 
                    customerRequest: { 
                        email: "sub@geidea-ksa.com",
                        phoneNumber: SAUDI_PHONE_NUMBER,
                        phoneCountryCode: SAUDI_COUNTRY_CODE
                    } 
                }
            }
        ];

        let logsText = "";
        let lastSessionId = null;

        function log(message, type = 'info', details = null) {
            const term = document.getElementById('terminalOutput');
            const time = new Date().toLocaleTimeString();
            let colorClass = '';
            
            if (type === 'success') colorClass = 'status-ok';
            else if (type === 'error') colorClass = 'status-fail';
            else if (type === 'warn') colorClass = 'status-warn';

            let html = `<div class="log-entry">
                <span class="log-time">[${time}]</span>
                <span class="${colorClass}">${message}</span>`;
            
            if (details) {
                html += `<span class="details">${details}</span>`;
            }
            html += `</div>`;

            term.innerHTML += html;
            term.scrollTop = term.scrollHeight;
            logsText += `[${time}] ${message}\n${details ? details + '\n' : ''}`;
        }

        async function runFullDiagnostics() {
            const btn = document.getElementById('startBtn');
            const term = document.getElementById('terminalOutput');
            
            btn.disabled = true;
            term.innerHTML = "";
            logsText = "";
            
            log("ðŸš€ Starting KSA Diagnostic Sequence (FINAL)...", "warn");
            log(`â„¹ï¸ Phone: ${SAUDI_COUNTRY_CODE}-${SAUDI_PHONE_NUMBER}`, "info");
            log("---------------------------------------------------");

            if (typeof GeideaCheckout === 'undefined') {
                log("âŒ CRITICAL: Geidea JS Library NOT loaded! AdBlock?", "error");
            } else {
                log("âœ… Geidea JS Library Loaded.", "success");
            }

            for (let op of OPERATIONS) {
                await runSingleTest(op);
                await new Promise(r => setTimeout(r, 1000));
            }

            log("---------------------------------------------------");
            log("ðŸ Diagnostic Complete.", "warn");
            btn.disabled = false;
        }

        async function runSingleTest(op) {
            log(`ðŸ”„ Testing: ${op.name} [${op.id}]...`, "info");

            let currentPayload = { ...op.payload };

            try {
                const res = await fetch('/.netlify/functions/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: op.id, payload: currentPayload })
                });

                const data = await res.json();
                const status = data._statusCode || res.status;

                if (status >= 200 && status < 300) {
                    let detailMsg = `Status: ${status} OK`;
                    const sessId = data.session?.id || data.id;
                    
                    if (sessId && op.id === 'createSession') {
                        lastSessionId = sessId;
                        detailMsg += `\nðŸ†” Session ID: ${sessId}`;
                        
                        if (op.checkWindow) {
                            detailMsg += `\nâœ… Window Ready`;
                            setTimeout(() => {
                                const btnId = `btn-${sessId.substring(0,8)}`;
                                const term = document.getElementById('terminalOutput');
                                term.lastElementChild.innerHTML += ` <button id="${btnId}" style="width:auto; padding:2px 10px; font-size:10px; margin:0; display:inline;" onclick="openTestWindow('${sessId}')">Test Window</button>`;
                            }, 100);
                        }
                    }
                    
                    if (data.paymentUrl) {
                        detailMsg += `\nðŸ”— URL: ${data.paymentUrl}`;
                    }

                    log(`âœ… ${op.name}: SUCCESS`, "success", detailMsg);

                } else {
                    let errorMsg = JSON.stringify(data);
                    if (data.detailedResponseMessage) errorMsg = data.detailedResponseMessage;
                    else if (data.responseMessage) errorMsg = data.responseMessage;
                    else if (data.errors) errorMsg = JSON.stringify(data.errors);
                    
                    log(`âŒ ${op.name}: FAILED (${status})`, "error", `Server Msg: ${errorMsg}\nPayload: ${JSON.stringify(currentPayload)}`);
                }

            } catch (err) {
                log(`âŒ ${op.name}: NETWORK ERROR`, "error", err.message);
            }
        }

        function openTestWindow(sessionId) {
            if (typeof GeideaCheckout === 'undefined') {
                alert("Ø§Ù„Ù…ÙƒØªØ¨Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©!");
                return;
            }
            const payment = new GeideaCheckout(
                s => console.log(s), 
                e => console.error(e), 
                () => console.log("Cancel")
            );
            payment.startPayment(sessionId);
        }

        function copyLogs() {
            navigator.clipboard.writeText(logsText).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerText = "Copied!";
                setTimeout(() => btn.innerText = "Copy Logs", 2000);
            });
        }
    </script>
</body>
</html>