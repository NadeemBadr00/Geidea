<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المستخدم والمحفظة</title>
    
    <!-- Geidea Script -->
    <script src="geideaCheckout.min.js" onerror="loadExternalScript()"></script>
    <script>
        function loadExternalScript() {
            console.warn("Local script not found, trying CDN...");
            var script = document.createElement('script');
            script.src = "https://www.ksamerchant.geidea.net/hpp/geideaCheckout.min.js";
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 420px; text-align: center; transition: all 0.3s ease; }
        
        /* Profile & Data Styles */
        .data-card { display: none; text-align: right; animation: fadeIn 0.5s; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: #666; font-size: 0.9em; }
        .data-value { font-weight: bold; color: #333; font-family: monospace; font-size: 1.1em; }
        
        .balance-box { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); }
        .balance-amount { font-size: 32px; font-weight: bold; display: block; margin-top: 5px; }
        .balance-label { font-size: 0.9em; opacity: 0.9; }

        /* Form Styles */
        h2 { color: #333; margin-top: 0; }
        input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #f9f9f9; }
        input:focus { border-color: #4caf50; background: #fff; outline: none; }
        
        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; margin-top: 15px; }
        .btn-primary { background: #333; color: white; }
        .btn-primary:hover { background: #000; }
        .btn-success { background: #4caf50; color: white; margin-top: 10px; }
        .btn-success:hover { background: #43a047; }
        
        .status { margin-top: 15px; font-size: 14px; color: #666; min-height: 20px; text-align: center; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #555; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: none; vertical-align: middle; margin-left: 10px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- قسم تسجيل الدخول -->
        <div id="loginSection">
            <h2>تسجيل الدخول / إنشاء حساب</h2>
            <p style="color:#777; font-size:0.9em;">أدخل بياناتك لعرض محفظتك أو الشحن</p>
            
            <input type="text" id="name" placeholder="الاسم (للمستخدمين الجدد)">
            <input type="email" id="email" placeholder="البريد الإلكتروني">
            <input type="password" id="password" placeholder="كلمة المرور">
            
            <button class="btn btn-primary" id="loginBtn" onclick="handleAuth()">
                دخول / تسجيل
                <span class="loader" id="loginLoader"></span>
            </button>
        </div>

        <!-- قسم البيانات والمحفظة (يظهر بعد الدخول) -->
        <div id="profileSection" style="display: none;">
            <h2>محفظتي</h2>
            
            <!-- صندوق الرصيد -->
            <div class="balance-box">
                <span class="balance-label">الرصيد الحالي</span>
                <span class="balance-amount" id="displayBalance">0.00 <small>SAR</small></span>
            </div>

            <!-- تفاصيل البيانات التقنية -->
            <div class="data-card" style="display: block;">
                <div class="data-row">
                    <span class="data-label">الاسم المسجل</span>
                    <span class="data-value" id="displayName">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">User ID (UID)</span>
                    <span class="data-value" id="displayUid" style="font-size: 0.8em;">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">حالة الحساب</span>
                    <span class="data-value" id="displayStatus" style="color: #666;">مجاني</span>
                </div>
            </div>

            <button class="btn btn-success" id="payBtn" onclick="initiateTopUp()">
                شحن رصيد (100 ر.س)
                <span class="loader" id="payLoader"></span>
            </button>
            
            <button class="btn" style="background:transparent; color:#888; margin-top:5px;" onclick="location.reload()">تسجيل خروج</button>
        </div>

        <div id="statusMessage" class="status"></div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6WQKgXjdqe3ghQEQ5EXAMZM7ffiWlabk",
            authDomain: "ai-roadmap-jnadeem.firebaseapp.com",
            projectId: "ai-roadmap-jnadeem",
            storageBucket: "ai-roadmap-jnadeem.firebasestorage.app",
            messagingSenderId: "332299268804",
            appId: "1:332299268804:web:225b27d243845688194f91",
            measurementId: "G-P8E119RZDX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Refs
        const loginSection = document.getElementById('loginSection');
        const profileSection = document.getElementById('profileSection');
        const statusDiv = document.getElementById('statusMessage');
        
        let currentUser = null; // لتخزين كائن المستخدم الحالي

        // 1. الدخول والتحقق
        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('loginLoader');

            if(!email || !password) {
                showStatus("الرجاء إدخال البريد وكلمة المرور", "red");
                return;
            }

            btn.disabled = true;
            loader.style.display = "inline-block";
            showStatus("جاري التحقق...", "blue");

            try {
                let userCredential;
                // محاولة تسجيل الدخول أولاً
                try {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                    showStatus("تم تسجيل الدخول بنجاح", "green");
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        // إذا لم يوجد، ننشئ حساب جديد
                        if (!name) {
                             throw new Error("هذا البريد غير مسجل. الرجاء إدخال الاسم لإنشاء حساب جديد.");
                        }
                        showStatus("حساب جديد، جاري الإنشاء...", "blue");
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        // إنشاء المستند الأولي في قاعدة البيانات
                        await createInitialUserDoc(userCredential.user, name);
                    } else {
                        throw error;
                    }
                }

                currentUser = userCredential.user;
                await loadUserProfile(currentUser.uid);
                
                // تبديل الواجهة
                loginSection.style.display = "none";
                profileSection.style.display = "block";
                statusDiv.innerText = "";

            } catch (err) {
                console.error(err);
                showStatus(err.message, "red");
                btn.disabled = false;
                loader.style.display = "none";
            }
        };

        // 2. إنشاء مستند قاعدة البيانات (للمستخدم الجديد فقط)
        async function createInitialUserDoc(user, displayName) {
            const userRef = doc(db, "users", user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                email: user.email,
                displayName: displayName,
                walletBalance: 0,
                isPremium: false,
                createdAt: serverTimestamp()
            });
        }

        // 3. جلب وعرض البيانات (للمستخدم الحالي)
        async function loadUserProfile(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // تعبئة البيانات في الواجهة
                document.getElementById('displayUid').innerText = data.uid;
                document.getElementById('displayName').innerText = data.displayName || "مستخدم";
                document.getElementById('displayBalance').innerHTML = `${data.walletBalance.toFixed(2)} <small>SAR</small>`;
                
                if(data.isPremium) {
                    document.getElementById('displayStatus').innerText = "عضوية ذهبية (Premium)";
                    document.getElementById('displayStatus').style.color = "#d4af37";
                    document.getElementById('displayStatus').style.fontWeight = "bold";
                }
            } else {
                console.log("No such document!");
                showStatus("لم يتم العثور على بيانات المحفظة", "orange");
            }
        }

        // 4. عملية الشحن (الدفع)
        window.initiateTopUp = async () => {
            if(!currentUser) return;
            
            const btn = document.getElementById('payBtn');
            const loader = document.getElementById('payLoader');
            const amount = 100.00;

            btn.disabled = true;
            loader.style.display = "inline-block";
            showStatus("جاري الاتصال ببوابة الدفع...", "blue");

            try {
                // استدعاء دالة السيرفر
                const response = await fetch('/.netlify/functions/create-payment-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: amount, 
                        customerEmail: currentUser.email,
                        userId: currentUser.uid 
                    })
                });

                const data = await response.json();

                if (data.success && data.sessionId) {
                    showStatus("نافذة الدفع جاهزة...", "green");
                    
                    if (typeof GeideaCheckout === 'undefined') {
                        throw new Error("مكتبة الدفع غير محملة");
                    }

                    const payment = new GeideaCheckout(
                        async function(success) {
                            showStatus("✅ تم الدفع! جاري تحديث الرصيد...", "blue");
                            
                            // تحديث الرصيد في قاعدة البيانات
                            const userRef = doc(db, "users", currentUser.uid);
                            await updateDoc(userRef, {
                                walletBalance: increment(amount),
                                isPremium: true,
                                lastPaymentDate: serverTimestamp()
                            });

                            // إعادة تحميل البيانات لعرض الرصيد الجديد
                            await loadUserProfile(currentUser.uid);
                            
                            showStatus("تم الشحن بنجاح!", "green");
                            btn.disabled = false;
                            loader.style.display = "none";
                        },
                        function(err) {
                            showStatus("❌ فشل الدفع", "red");
                            btn.disabled = false;
                            loader.style.display = "none";
                        },
                        function() {
                            showStatus("⚠️ تم إلغاء العملية", "orange");
                            btn.disabled = false;
                            loader.style.display = "none";
                        }
                    );

                    payment.startPayment(data.sessionId);

                } else {
                    throw new Error("فشل في إنشاء جلسة الدفع");
                }

            } catch (err) {
                console.error(err);
                showStatus(err.message, "red");
                btn.disabled = false;
                loader.style.display = "none";
            }
        };

        function showStatus(msg, color) {
            statusDiv.innerText = msg;
            statusDiv.style.color = color || "black";
        }
    </script>
</body>
</html>