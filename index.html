<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geidea Ultimate Tester</title>
    
    <!-- Ù…ÙƒØªØ¨Ø© Geidea JS -->
    <script src="https://ksamerchant.geidea.net/payment-intent/online/v1/geidea-checkout.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 25px; }
        h1 { color: #00d082; text-align: center; margin-bottom: 30px; }
        
        .control-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        select, textarea, button, input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        textarea { height: 200px; font-family: monospace; direction: ltr; background: #fafafa; }
        
        button { background: #00d082; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; margin-top: 10px; }
        button:hover { background: #00b06d; }
        
        .response-box { background: #2d2d2d; color: #76e094; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; font-family: monospace; direction: ltr; min-height: 100px; margin-top: 10px; }
        
        .status-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .success { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ› ï¸ Geidea API Tester</h1>
        
        <div class="control-group">
            <label>1. Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Operation):</label>
            <select id="opSelect" onchange="loadTemplate()">
                <optgroup label="Checkout V2">
                    <option value="createSession">Create Session (Pay)</option>
                    <option value="createSessionSubscription">Create Session Subscription</option>
                    <option value="saveCard">Save Card</option>
                </optgroup>
                <optgroup label="Pay By Link">
                    <option value="createQuickLink">Create Quick Link</option>
                    <option value="createPaymentLink">Create Invoice Link</option>
                    <option value="getAllPaymentLinks">Get All Links</option>
                    <option value="deletePaymentLink">Delete Link</option>
                </optgroup>
                <optgroup label="Meeza & QR">
                    <option value="createMeezaQR">Create Meeza QR</option>
                    <option value="meezaRequestToPay">Request to Pay (Wallet)</option>
                </optgroup>
                <optgroup label="Direct API & Actions">
                    <option value="capture">Capture (ØªØ­ØµÙŠÙ„)</option>
                    <option value="void">Void (Ø¥Ù„ØºØ§Ø¡)</option>
                    <option value="refund">Refund (Ø§Ø³ØªØ±Ø¬Ø§Ø¹)</option>
                    <option value="fetchOrderById">Get Order Details</option>
                </optgroup>
                <optgroup label="Subscription Management">
                    <option value="createSubscription">Create Subscription</option>
                    <option value="getSubscription">Get Subscription Details</option>
                    <option value="cancelSubscription">Cancel Subscription</option>
                </optgroup>
            </select>
        </div>

        <div class="control-group">
            <label>2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Payload):</label>
            <textarea id="payloadJson"></textarea>
        </div>

        <button onclick="sendRequest()" id="sendBtn">ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨</button>

        <div class="control-group" style="margin-top: 30px;">
            <label>3. Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± (Response):</label>
            <div id="statusTag"></div>
            <div id="responseBox" class="response-box">// Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
        </div>
        
        <button id="payBtn" style="display:none; background: #007bff;" onclick="openCheckout()">ğŸ’³ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹</button>
    </div>

    <script>
        // Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
        const TEMPLATES = {
            createSession: {
                amount: 100,
                currency: "SAR",
                paymentOperation: "Pay",
                appearance: { uiMode: "modal" },
                customer: { email: "test@geidea.com" }
            },
            createSessionSubscription: {
                amount: 150,
                currency: "SAR",
                subscriptionId: "Ø¶Ø¹_ID_Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ_Ù‡Ù†Ø§"
            },
            saveCard: {
                currency: "SAR"
            },
            createQuickLink: {
                amount: 50,
                currency: "SAR",
                customer: { name: "Client", phoneNumber: "500000000" }
            },
            createMeezaQR: {
                // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                sessionId: "ÙŠØ¬Ø¨_Ø§Ù†Ø´Ø§Ø¡_Ø¬Ù„Ø³Ø©_Ø§ÙˆÙ„Ø§",
                customerEmail: "client@test.com",
                customerPhoneCountryCode: "+20",
                source: "HPP"
            },
            refund: {
                orderId: "Ø¶Ø¹_Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨_Ù‡Ù†Ø§",
                refundAmount: 10.00,
                currency: "SAR"
            },
            fetchOrderById: {
                pathParams: { orderId: "Ø¶Ø¹_Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨_Ù‡Ù†Ø§" }
            },
            deletePaymentLink: {
                pathParams: { paymentIntentId: "Ø¶Ø¹_Ø§Ù„Ø±Ù‚Ù…_Ù‡Ù†Ø§" }
            },
            createSubscription: {
                recurringPaymentAmount: 100,
                currency: "SAR",
                cycleInterval: "month",
                cycleFrequency: 12,
                typeOfPayment: "RecurringPayment",
                isFirstPmtPBL: true, // true = ÙŠØ±Ø³Ù„ Ø±Ø§Ø¨Ø· Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ÙˆÙ„
                customerRequest: { email: "sub@test.com" }
            }
        };

        let lastResponse = null;

        function loadTemplate() {
            const op = document.getElementById('opSelect').value;
            const data = TEMPLATES[op] || { note: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚" };
            document.getElementById('payloadJson').value = JSON.stringify(data, null, 2);
            document.getElementById('payBtn').style.display = 'none';
        }

        async function sendRequest() {
            const btn = document.getElementById('sendBtn');
            const box = document.getElementById('responseBox');
            const statusTag = document.getElementById('statusTag');
            const op = document.getElementById('opSelect').value;

            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
            box.innerText = "Waiting...";
            statusTag.innerHTML = "";

            try {
                const payload = JSON.parse(document.getElementById('payloadJson').value);
                
                const res = await fetch('/.netlify/functions/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: op, payload: payload })
                });

                const data = await res.json();
                lastResponse = data;

                const code = data._statusCode || 200;
                const isSuccess = code >= 200 && code < 300;
                
                statusTag.innerHTML = `<span class="status-tag ${isSuccess ? 'success' : 'fail'}">Status: ${code}</span>`;
                box.innerText = JSON.stringify(data, null, 2);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯ÙØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Session ID
                if (isSuccess && (data.session?.id || data.id) && op.includes('Session')) {
                    document.getElementById('payBtn').style.display = 'block';
                } else {
                    document.getElementById('payBtn').style.display = 'none';
                }

            } catch (err) {
                statusTag.innerHTML = `<span class="status-tag fail">Client Error</span>`;
                box.innerText = err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨";
            }
        }

        function openCheckout() {
            if (!lastResponse) return;
            const sessionId = lastResponse.session?.id || lastResponse.id;
            
            if (typeof GeideaCheckout !== 'undefined' && sessionId) {
                const payment = new GeideaCheckout(
                    s => alert("Success: " + JSON.stringify(s)),
                    e => alert("Error: " + JSON.stringify(e)),
                    () => console.log("Cancel")
                );
                payment.startPayment(sessionId);
            } else {
                alert("Session ID missing or Library not loaded.");
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        loadTemplate();
    </script>
</body>
</html>