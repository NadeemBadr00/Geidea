<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شحن المحفظة - اختيار المبلغ</title>
    
    <!-- Geidea Script -->
    <script src="geideaCheckout.min.js" onerror="loadExternalScript()"></script>
    <script>
        function loadExternalScript() {
            console.warn("Local script not found, trying CDN...");
            var script = document.createElement('script');
            script.src = "https://www.ksamerchant.geidea.net/hpp/geideaCheckout.min.js";
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 420px; text-align: center; transition: all 0.3s ease; }
        
        /* Profile & Data Styles */
        .data-card { display: none; text-align: right; animation: fadeIn 0.5s; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 20px; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: #666; font-size: 0.9em; }
        .data-value { font-weight: bold; color: #333; font-family: monospace; font-size: 1.1em; }
        
        .balance-box { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0 10px 0; text-align: center; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); }
        .balance-amount { font-size: 32px; font-weight: bold; display: block; margin-top: 5px; }
        .balance-label { font-size: 0.9em; opacity: 0.9; }

        /* Amount Selection Styles */
        .amount-selector { margin-top: 20px; text-align: right; }
        .amount-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; }
        .amt-btn { background: #fff; border: 1px solid #ddd; padding: 10px 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: bold; color: #555; font-size: 14px; }
        .amt-btn:hover { background: #f9f9f9; border-color: #bbb; }
        .amt-btn.active { background: #e8f5e9; color: #2e7d32; border-color: #4caf50; box-shadow: 0 0 0 1px #4caf50; }
        
        .custom-input-wrapper { position: relative; margin-top: 10px; }
        .custom-input-wrapper input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; text-align: center; font-weight: bold; transition: 0.3s; }
        .custom-input-wrapper input:focus { border-color: #4caf50; outline: none; background: #fff; }
        .currency-suffix { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; font-size: 12px; pointer-events: none; }

        /* Form Styles */
        h2 { color: #333; margin-top: 0; }
        .login-input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #f9f9f9; }
        
        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; margin-top: 15px; position: relative; }
        .btn-primary { background: #333; color: white; }
        .btn-primary:hover { background: #000; }
        .btn-success { background: #4caf50; color: white; margin-top: 15px; }
        .btn-success:hover { background: #43a047; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .status { margin-top: 15px; font-size: 14px; color: #666; min-height: 20px; text-align: center; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #555; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; vertical-align: middle; position: absolute; left: 20px; top: 14px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- قسم تسجيل الدخول -->
        <div id="loginSection">
            <h2>تسجيل الدخول</h2>
            <p style="color:#777; font-size:0.9em;">سجل الدخول لشحن رصيدك</p>
            
            <input type="text" id="name" class="login-input" placeholder="الاسم (للمستخدمين الجدد)">
            <input type="email" id="email" class="login-input" placeholder="البريد الإلكتروني">
            <input type="password" id="password" class="login-input" placeholder="كلمة المرور">
            
            <button class="btn btn-primary" id="loginBtn" onclick="handleAuth()">
                دخول / تسجيل
                <span class="loader" id="loginLoader"></span>
            </button>
        </div>

        <!-- قسم البيانات والمحفظة (يظهر بعد الدخول) -->
        <div id="profileSection" style="display: none;">
            <h2>محفظتي</h2>
            
            <!-- صندوق الرصيد -->
            <div class="balance-box">
                <span class="balance-label">الرصيد الحالي</span>
                <span class="balance-amount" id="displayBalance">0.00 <small>SAR</small></span>
            </div>

            <!-- اختيار المبلغ -->
            <div class="amount-selector">
                <p class="data-label" style="margin-bottom: 5px;">كم تريد أن تشحن؟</p>
                <div class="amount-grid">
                    <button class="amt-btn" onclick="selectAmount(50)">50</button>
                    <button class="amt-btn active" onclick="selectAmount(100)">100</button>
                    <button class="amt-btn" onclick="selectAmount(200)">200</button>
                    <button class="amt-btn" onclick="selectAmount(500)">500</button>
                </div>
                <div class="custom-input-wrapper">
                    <input type="number" id="customAmount" placeholder="أو أدخل مبلغاً آخر" oninput="handleCustomInput(this)">
                    <span class="currency-suffix">SAR</span>
                </div>
            </div>

            <button class="btn btn-success" id="payBtn" onclick="initiateTopUp()">
                شحن رصيد (100 ر.س)
                <span class="loader" id="payLoader"></span>
            </button>

            <!-- تفاصيل البيانات التقنية -->
            <div class="data-card">
                <div class="data-row">
                    <span class="data-label">الاسم المسجل</span>
                    <span class="data-value" id="displayName">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">User ID</span>
                    <span class="data-value" id="displayUid" style="font-size: 0.8em;">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">حالة الحساب</span>
                    <span class="data-value" id="displayStatus" style="color: #666;">مجاني</span>
                </div>
            </div>
            
            <button class="btn" style="background:transparent; color:#888; margin-top:5px; font-weight:normal; font-size:14px;" onclick="location.reload()">تسجيل خروج</button>
        </div>

        <div id="statusMessage" class="status"></div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6WQKgXjdqe3ghQEQ5EXAMZM7ffiWlabk",
            authDomain: "ai-roadmap-jnadeem.firebaseapp.com",
            projectId: "ai-roadmap-jnadeem",
            storageBucket: "ai-roadmap-jnadeem.firebasestorage.app",
            messagingSenderId: "332299268804",
            appId: "1:332299268804:web:225b27d243845688194f91",
            measurementId: "G-P8E119RZDX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- منطق اختيار المبلغ ---
        let selectedAmount = 100; // القيمة الافتراضية

        window.selectAmount = (amount) => {
            selectedAmount = amount;
            // تحديث شكل الأزرار
            document.querySelectorAll('.amt-btn').forEach(btn => {
                const isActive = parseInt(btn.innerText) === amount;
                btn.classList.toggle('active', isActive);
            });
            // تفريغ الحقل المخصص
            document.getElementById('customAmount').value = '';
            updatePayButtonText();
        }

        window.handleCustomInput = (input) => {
            // إزالة التنشيط من جميع الأزرار الجاهزة
            document.querySelectorAll('.amt-btn').forEach(btn => btn.classList.remove('active'));
            
            const val = parseFloat(input.value);
            if (val && val > 0) {
                selectedAmount = val;
            } else {
                selectedAmount = 0;
            }
            updatePayButtonText();
        }

        function updatePayButtonText() {
            const btn = document.getElementById('payBtn');
            const loaderHtml = '<span class="loader" id="payLoader"></span>';
            
            if (selectedAmount > 0) {
                btn.innerHTML = `شحن رصيد (${selectedAmount} ر.س) ${loaderHtml}`;
                btn.disabled = false;
            } else {
                btn.innerHTML = `الرجاء تحديد مبلغ ${loaderHtml}`;
                btn.disabled = true;
            }
        }
        // ------------------------

        // UI Refs
        const loginSection = document.getElementById('loginSection');
        const profileSection = document.getElementById('profileSection');
        const statusDiv = document.getElementById('statusMessage');
        
        let currentUser = null;

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('loginLoader');

            if(!email || !password) {
                showStatus("الرجاء إدخال البريد وكلمة المرور", "red");
                return;
            }

            btn.disabled = true;
            loader.style.display = "block";
            showStatus("جاري التحقق...", "blue");

            try {
                let userCredential;
                try {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        if (!name) throw new Error("مستخدم جديد؟ أدخل اسمك لإنشاء حساب.");
                        showStatus("حساب جديد، جاري الإنشاء...", "blue");
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await createInitialUserDoc(userCredential.user, name);
                    } else {
                        throw error;
                    }
                }

                currentUser = userCredential.user;
                await loadUserProfile(currentUser.uid);
                
                loginSection.style.display = "none";
                profileSection.style.display = "block";
                statusDiv.innerText = "";

            } catch (err) {
                console.error(err);
                showStatus(err.message, "red");
                btn.disabled = false;
                loader.style.display = "none";
            }
        };

        async function createInitialUserDoc(user, displayName) {
            const userRef = doc(db, "users", user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                email: user.email,
                displayName: displayName,
                walletBalance: 0,
                isPremium: false,
                createdAt: serverTimestamp()
            });
        }

        async function loadUserProfile(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('displayUid').innerText = data.uid;
                document.getElementById('displayName').innerText = data.displayName || "مستخدم";
                document.getElementById('displayBalance').innerHTML = `${data.walletBalance.toFixed(2)} <small>SAR</small>`;
                
                if(data.isPremium) {
                    document.getElementById('displayStatus').innerText = "عضوية ذهبية";
                    document.getElementById('displayStatus').style.color = "#d4af37";
                    document.getElementById('displayStatus').style.fontWeight = "bold";
                }
            }
        }

        // دالة الشحن المحدثة لتستخدم selectedAmount
        window.initiateTopUp = async () => {
            if(!currentUser) return;
            if(!selectedAmount || selectedAmount <= 0) {
                alert("الرجاء اختيار مبلغ صحيح");
                return;
            }
            
            const btn = document.getElementById('payBtn');
            const loader = document.getElementById('payLoader');
            // حفظ القيمة الحالية لتجنب تغييرها أثناء العملية
            const amountToCharge = selectedAmount;

            btn.disabled = true;
            loader.style.display = "block";
            showStatus("جاري الاتصال...", "blue");

            try {
                const requestPayload = {
                    operation: 'createSession',
                    payload: {
                        amount: amountToCharge, // القيمة الديناميكية
                        currency: "SAR",
                        paymentOperation: "Pay",
                        appearance: { uiMode: "modal" },
                        customer: { email: currentUser.email },
                        merchantReferenceId: currentUser.uid
                    }
                };

                const response = await fetch('/.netlify/functions/create-payment-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (response.status === 404) throw new Error("لم يتم العثور على دالة الدفع");

                const data = await response.json();

                if (data.session && data.session.id) {
                    showStatus("نافذة الدفع جاهزة...", "green");
                    
                    if (typeof GeideaCheckout === 'undefined') throw new Error("مكتبة الدفع غير محملة");

                    const payment = new GeideaCheckout(
                        async function(success) {
                            showStatus("✅ تم الدفع! تحديث الرصيد...", "blue");
                            
                            const userRef = doc(db, "users", currentUser.uid);
                            await updateDoc(userRef, {
                                walletBalance: increment(amountToCharge),
                                isPremium: true,
                                lastPaymentDate: serverTimestamp()
                            });

                            await loadUserProfile(currentUser.uid);
                            showStatus("تم الشحن بنجاح!", "green");
                            
                            // إعادة تعيين الزر
                            btn.disabled = false;
                            loader.style.display = "none";
                            // لا نعيد النص للأصل حتى يرى المستخدم المبلغ الذي دفعه، أو يمكن تحديثه يدوياً
                            updatePayButtonText(); 
                        },
                        function(err) {
                            showStatus("❌ فشل الدفع", "red");
                            btn.disabled = false;
                            loader.style.display = "none";
                        },
                        function() {
                            showStatus("⚠️ تم الإلغاء", "orange");
                            btn.disabled = false;
                            loader.style.display = "none";
                        }
                    );

                    payment.startPayment(data.session.id);

                } else {
                    throw new Error(data.detailedResponseMessage || "فشل إنشاء الجلسة");
                }

            } catch (err) {
                console.error(err);
                showStatus(err.message, "red");
                btn.disabled = false;
                loader.style.display = "none";
            }
        };

        function showStatus(msg, color) {
            statusDiv.innerText = msg;
            statusDiv.style.color = color || "black";
        }
    </script>
</body>
</html>