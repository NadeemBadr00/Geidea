<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geidea All-in-One Tester</title>
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø¬ÙŠÙŠØ¯ÙŠØ§ -->
    <script src="https://ksamerchant.geidea.net/payment-intent/online/v1/geidea-checkout.min.js"></script>
    
    <style>
        :root { --primary: #00d082; --bg: #f4f6f8; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        h2 { margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; font-size: 18px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        select, button, textarea, input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; font-family: monospace; box-sizing: border-box; }
        textarea { height: 250px; resize: vertical; direction: ltr; }
        
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; }
        
        #responseArea { background: #1e1e1e; color: #00ff00; height: 300px; overflow: auto; padding: 10px; white-space: pre-wrap; direction: ltr; border-radius: 6px; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .status-200 { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="card full-width">
            <h1 style="text-align: center; color: var(--primary);">Geidea Integration Tester</h1>
            <p style="text-align: center; color: #666;">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø¹Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙˆØ§Ø¶ØºØ· ØªÙ†ÙÙŠØ°.</p>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
        <div class="card">
            <h2>1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨</h2>
            
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Operation):</label>
            <select id="operationSelect" onchange="loadTemplate()">
                <optgroup label="Checkout & Payments">
                    <option value="createSession">Create Session (Checkout V2)</option>
                    <option value="createSessionSubscription">Create Session Subscription</option>
                    <option value="saveCard">Save Card (Standalone)</option>
                </optgroup>
                <optgroup label="Pay By Link">
                    <option value="createQuickLink">Create Quick Payment Link</option>
                    <option value="createPaymentLink">Create Payment Link (Invoice)</option>
                    <option value="getAllPaymentLinks">Get All Payment Links</option>
                </optgroup>
                <optgroup label="Meeza & QR">
                    <option value="createMeezaQR">Create Meeza QR Code</option>
                    <option value="meezaRequestToPay">Meeza Request To Pay</option>
                </optgroup>
                <optgroup label="Direct API Operations">
                    <option value="refund">Refund (Ø§Ø³ØªØ±Ø¬Ø§Ø¹)</option>
                    <option value="capture">Capture (ØªØ­ØµÙŠÙ„)</option>
                    <option value="void">Void (Ø¥Ù„ØºØ§Ø¡)</option>
                    <option value="getOrder">Get Order Details</option>
                </optgroup>
            </select>

            <label>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (JSON Payload):</label>
            <textarea id="payloadInput"></textarea>

            <button id="executeBtn" onclick="executeRequest()">ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div class="card">
            <h2>2. Ø§Ù„Ù†ØªÙŠØ¬Ø© (Server Response)</h2>
            <div id="statusBadge" class="status-badge" style="display:none;"></div>
            <div id="responseArea">// Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
            
            <div id="actionArea" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; display: none;">
                <label>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
                <button id="openCheckoutBtn" onclick="openGeideaModal()" style="background: #2196F3;">ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ (Checkout)</button>
            </div>
        </div>
    </div>

    <script>
        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
        const TEMPLATES = {
            createSession: {
                amount: 100,
                currency: "SAR",
                // merchantReferenceId: Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¥Ø°Ø§ ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹
                appearance: { uiMode: "modal" },
                customer: { email: "test@geidea.com" }
            },
            createQuickLink: {
                amount: 150,
                currency: "SAR",
                customer: { name: "Ahmed", phoneNumber: "500000000" }
            },
            createMeezaQR: {
                merchantPublicKey: "Ø¶Ø¹_Ø§Ù„Ù…ÙØªØ§Ø­_Ù‡Ù†Ø§", 
                sessionId: "Ø¶Ø¹_SessionID_Ù‡Ù†Ø§",
                customerEmail: "customer@example.com",
                customerPhoneCountryCode: "+20",
                source: "HPP"
            },
            refund: {
                orderId: "Ø¶Ø¹_Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨_Ù‡Ù†Ø§",
                refundAmount: 10.00,
                currency: "SAR"
            },
            getOrder: {
                pathParams: { orderId: "Ø¶Ø¹_Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨_Ù‡Ù†Ø§" } // Ù…Ø«Ø§Ù„ Ù„ÙƒÙŠÙÙŠØ© ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
            }
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.onload = loadTemplate;

        function loadTemplate() {
            const op = document.getElementById('operationSelect').value;
            const template = TEMPLATES[op] || { note: "Ù‚Ù… Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚" };
            document.getElementById('payloadInput').value = JSON.stringify(template, null, 2);
            document.getElementById('actionArea').style.display = 'none';
            document.getElementById('responseArea').innerText = '// Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°...';
            document.getElementById('statusBadge').style.display = 'none';
        }

        let lastResponseData = null;

        async function executeRequest() {
            const btn = document.getElementById('executeBtn');
            const responseArea = document.getElementById('responseArea');
            const statusBadge = document.getElementById('statusBadge');
            const op = document.getElementById('operationSelect').value;
            
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
            responseArea.innerText = "Loading...";
            statusBadge.style.display = 'none';

            try {
                let payload = {};
                try {
                    payload = JSON.parse(document.getElementById('payloadInput').value);
                } catch (e) {
                    throw new Error("Ø®Ø·Ø£ ÙÙŠ ØµÙŠØºØ© JSON. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙˆØ§Ù„ÙÙˆØ§ØµÙ„.");
                }

                const res = await fetch('/.netlify/functions/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: op,
                        payload: payload
                    })
                });

                const data = await res.json();
                lastResponseData = data;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
                const statusCode = data._statusCode || res.status;
                statusBadge.innerText = `Status: ${statusCode}`;
                statusBadge.className = `status-badge ${statusCode >= 200 && statusCode < 300 ? 'status-200' : 'status-error'}`;
                statusBadge.style.display = 'inline-block';

                responseArea.innerText = JSON.stringify(data, null, 2);

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Create Session ÙˆÙ†Ø§Ø¬Ø­Ø©ØŒ Ù†Ø¸Ù‡Ø± Ø²Ø± ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
                if (op === 'createSession' && (data.session || data.id)) {
                    document.getElementById('actionArea').style.display = 'block';
                } else {
                    document.getElementById('actionArea').style.display = 'none';
                }

            } catch (err) {
                responseArea.innerText = "Error: " + err.message;
                statusBadge.innerText = "Client Error";
                statusBadge.className = "status-badge status-error";
                statusBadge.style.display = 'inline-block';
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸš€ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨";
            }
        }

        function openGeideaModal() {
            if (!lastResponseData) return;
            
            const sessionId = lastResponseData.session?.id || lastResponseData.id;
            if (!sessionId) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Session ID ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©");
                return;
            }

            if (typeof GeideaCheckout === 'undefined') {
                alert("Ù…ÙƒØªØ¨Ø© Geidea Ù„Ù… ØªØªØ­Ù…Ù„. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø·ÙŠÙ„ AdBlock.");
                return;
            }

            const payment = new GeideaCheckout(
                (s) => alert("Ù†Ø¬Ø§Ø­! " + JSON.stringify(s)),
                (e) => alert("ÙØ´Ù„! " + JSON.stringify(e)),
                () => console.log("Ø¥Ù„ØºØ§Ø¡")
            );
            
            payment.startPayment(sessionId);
        }
    </script>
</body>
</html>